<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="Note2Flash_logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Study Smarter, Not Harder | Note2Flash</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <!-- Other Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="module">
      import { quizModeManager } from "./quiz-mode.js";
      window.quizModeManager = quizModeManager;
    </script>
    <style>
      body.create-deck-bg {
        background: linear-gradient(
          135deg,
          var(--primary-50) 0%,
          var(--primary-100) 100%
        );
        min-height: 100vh;
        position: relative;
      }
      body.create-deck-bg::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(59, 130, 246, 0.07) 0%,
          transparent 70%
        );
        pointer-events: none;
        z-index: -1;
      }
      main.container {
        position: relative;
        z-index: auto;
      }

      /* Ensure loading overlay is always on top */
      .loading-overlay {
        z-index: 999999 !important;
      }

      .loading-overlay.show {
        z-index: 999999 !important;
      }

      /* Flip Card Styles */
      .flashcard {
        perspective: 1000px !important;
        cursor: pointer !important;
        height: 400px !important;
        min-height: 400px !important;
        max-height: 400px !important;
        width: 100% !important;
        margin-bottom: 10px !important;
        position: relative !important;
        overflow: visible !important;
        display: block !important;
      }

      .flashcard-inner {
        position: relative !important;
        width: 100% !important;
        height: 100% !important;
        text-align: center !important;
        transition: transform 0.8s ease !important;
        transform-style: preserve-3d !important;
        border-radius: 12px !important;
        min-height: 400px !important;
        max-height: 400px !important;
        display: block !important;
      }

      #flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg) !important;
      }
      
      .flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg) !important;
      }

      .card-front,
      .card-back {
        position: absolute !important;
        width: 100% !important;
        height: 100% !important;
        backface-visibility: hidden !important;
        border-radius: 12px !important;
        padding: 30px !important;
        box-sizing: border-box !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        text-align: center !important;
        overflow: hidden !important;
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
        min-height: 400px !important;
        max-height: 400px !important;
      }

      .card-front {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid #dee2e6;
        font-size: 1.3rem;
        line-height: 1.6;
        color: #343a40;
      }

      .card-back {
        background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
        border: 2px solid #28a745;
        transform: rotateY(180deg);
        font-size: 1.2rem;
        line-height: 1.6;
        color: #155724;
      }

      .card-front strong,
      .card-back strong {
        color: #2a7f62;
        display: block;
        margin-bottom: 15px;
        font-size: 1.1em;
      }


      /* Ensure flashcard container takes full space */
      .flashcard-container {
        width: 100% !important;
        height: auto !important;
        min-height: 450px !important;
        padding: 20px !important;
      }

      .flashcard-viewer {
        width: 100% !important;
        height: auto !important;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .flashcard {
          height: 350px !important;
          min-height: 350px !important;
          max-height: 350px !important;
        }

        .flashcard-inner {
          min-height: 350px !important;
          max-height: 350px !important;
        }

        .card-front,
        .card-back {
          font-size: 1.1rem !important;
          padding: 20px !important;
          min-height: 350px !important;
          max-height: 350px !important;
        }


        .flashcard-container {
          min-height: 400px !important;
          padding: 15px !important;
        }
      }

      /* Flashcard Actions Dropdown */
      .flashcard-actions-dropdown {
        position: relative;
        display: inline-block;
      }

      .btn-actions {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #6c757d;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 16px;
        width: 40px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .btn-actions:hover {
        background: #e9ecef;
        color: #495057;
        border-color: #adb5bd;
      }

      .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 200px;
        z-index: 1000;
        display: none;
        padding: 8px 0;
        margin-top: 4px;
      }

      .dropdown-menu.show {
        display: block;
        animation: dropdownFadeIn 0.2s ease;
      }

      @keyframes dropdownFadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        padding: 10px 16px;
        color: #495057;
        text-decoration: none;
        font-size: 14px;
        transition: background-color 0.15s ease;
        border: none;
        background: none;
        width: 100%;
        cursor: pointer;
      }

      .dropdown-item:hover {
        background-color: #f8f9fa;
        color: #495057;
        text-decoration: none;
      }

      .dropdown-item i {
        margin-right: 12px;
        width: 16px;
        text-align: center;
        font-size: 14px;
      }

      .dropdown-item span {
        flex: 1;
      }

      .dropdown-item small {
        margin-left: 8px;
        color: #6c757d;
        font-size: 12px;
      }

      /* Different icon colors */
      .dropdown-item:nth-child(1) i { color: #28a745; } /* Study Now - Green */
      .dropdown-item:nth-child(2) i { color: #007bff; } /* Take Quiz - Blue */
      .dropdown-item:nth-child(3) i { color: #6c757d; } /* Save - Gray */
      .dropdown-item:nth-child(4) i { color: #fd7e14; } /* Export - Orange */

      /* Mobile responsive */
      @media (max-width: 768px) {
        .dropdown-menu {
          right: -10px;
          min-width: 160px;
        }
      }
    </style>
  </head>
  <body class="create-deck-bg">
    <!-- Navigation will be loaded here -->
    <div id="nav-placeholder"></div>

    <main class="container">
      <div class="grid-container">
        <!-- Left Column - Input Section -->
        <div class="grid-item">
          <h2>Study Smarter, Not Harder</h2>
          <div class="input-tabs">
            <button class="tab-btn active" data-tab="text">Text Input</button>
            <button class="tab-btn" data-tab="content">Content Upload</button>
            <button class="tab-btn" data-tab="url">Web Content</button>
          </div>

          <!-- Tab Content -->
          <div class="input-tab-content active" id="textTab">
            <form id="textForm" class="text-input-container">
              <textarea
                id="textInput"
                class="text-area-input"
                placeholder="Enter or paste your text here... 
Examples:
- Class notes
- Important concepts
- Step-by-step procedures
- Technical specifications"
                rows="10"
              ></textarea>
              
              <!-- Text Counter and Requirements -->
              <div class="text-counter">
                <span class="char-count" id="charCount">0</span> / 100 characters minimum
                <span class="recommended">(300+ recommended for best results)</span>
              </div>
              
              <!-- AI Output Options -->
              <div class="ai-output-options">
                <div class="output-toggle">
                  <label class="toggle-option">
                    <input type="radio" name="outputType" value="summary" checked>
                    <span class="toggle-label">
                      <i class="fas fa-sticky-note"></i> Create FlashNotes
                    </span>
                  </label>
                  <label class="toggle-option">
                    <input type="radio" name="outputType" value="flashcards">
                    <span class="toggle-label">
                      <i class="fas fa-layer-group"></i> Generate Flashcards
                    </span>
                  </label>
                </div>
              </div>

              <!-- Flashcard Options (shown when flashcards selected) -->
              <div class="generation-options" id="flashcardOptions" style="display: none;">
                      <select id="textCardType" class="select-input">
        <option value="term">Term & Definition</option>
        <option value="qa">Question & Answer</option>
        <option value="cloze">Cloze</option>
        <option value="contextual">Contextual/Scenario-based</option>
      </select>
                <select id="textCardCount" class="select-input">
                  <option value="5">5 cards</option>
                  <option value="10">10 cards</option>
                  <option value="15" class="premium-option">15 cards</option>
                  <option value="20" class="premium-option">20 cards</option>
                </select>
              </div>

              <!-- FlashNotes Options (shown when summary selected) -->
              <div class="generation-options" id="summaryOptions">
                <select id="summaryType" class="select-input">
                  <option value="quick">Bullet Point FlashNotes</option>
                  <option value="detailed" class="pro-option">Paragraph FlashNotes (Pro+)</option>
                  <option value="study" class="premium-option">Study Guide (Premium)</option>
                </select>
              </div>

              <button
                type="submit"
                class="btn btn-primary"
                id="generateFromTextBtn"
              >
                <i class="fas fa-magic"></i> <span id="generateButtonText">Create FlashNotes</span>
              </button>
            </form>
          </div>

          <!-- Content Upload Tab -->
          <div class="input-tab-content" id="contentTab">
            <div class="dropzone" id="dropzone">
              <i class="fas fa-cloud-upload-alt upload-icon"></i>
              <p>Drag & drop files here or click to upload</p>
              <p class="file-types">
                Supported files: PDF, DOCX, TXT, JPG, PNG
              </p>
              <input
                type="file"
                id="fileInput"
                accept=".pdf,.docx,.txt,.jpg,.jpeg,.png"
                style="display: none"
              />
            </div>

            <!-- AI Output Options -->
            <div class="ai-output-options">
              <div class="output-toggle">
                <label class="toggle-option">
                  <input type="radio" name="uploadOutputType" value="summary" checked>
                  <span class="toggle-label">
                    <i class="fas fa-sticky-note"></i> Create FlashNotes
                  </span>
                </label>
                <label class="toggle-option">
                  <input type="radio" name="uploadOutputType" value="flashcards">
                  <span class="toggle-label">
                    <i class="fas fa-layer-group"></i> Generate Flashcards
                  </span>
                </label>
              </div>
            </div>

            <!-- Flashcard Options (shown when flashcards selected) -->
            <div class="generation-options" id="uploadFlashcardOptions" style="display: none;">
                      <select id="uploadCardType" class="select-input">
          <option value="term" selected>Term & Definition</option>
          <option value="qa">Question & Answer</option>
          <option value="cloze">Cloze</option>
          <option value="contextual">Contextual/Scenario-based</option>
          <option value="image-occlusion" class="premium-option">Image Occlusion (Premium)</option>
        </select>
              <select id="uploadCardCount" class="select-input">
                <option value="5">5 cards</option>
                <option value="10">10 cards</option>
                <option value="15">15 cards (Premium)</option>
                <option value="20">20 cards (Premium)</option>
              </select>
            </div>

            <!-- FlashNotes Options (shown when summary selected) -->
            <div class="generation-options" id="uploadSummaryOptions">
              <select id="uploadSummaryType" class="select-input">
                <option value="quick">Bullet Point FlashNotes</option>
                <option value="detailed" class="pro-option">Paragraph FlashNotes (Pro+)</option>
                <option value="study" class="premium-option">Study Guide (Premium)</option>
              </select>
            </div>

            <!-- Card Type Selection -->
            <div id="cardTypeSelection">
              <button id="generateCardsBtn" class="btn btn-primary">
                <i class="fas fa-magic"></i> <span id="uploadGenerateButtonText">Create FlashNotes</span>
              </button>
            </div>
          </div>

          <!-- Web Content Tab -->
          <div class="input-tab-content" id="urlTab">
            <form id="urlForm">
              <div class="url-input-container">
                <div class="url-input-wrapper">
                  <input
                    type="url"
                    id="urlInput"
                    placeholder="https://example.com/article or 10.1234/example.doi"
                    class="url-input"
                  />
                </div>
                <div id="urlPreview" class="url-preview">
                  <div class="preview-header">
                    <h3 id="previewTitle">Content Preview</h3>
                    <div class="preview-actions">
                      <button
                        type="button"
                        id="editContentBtn"
                        class="btn btn-secondary"
                      >
                        <i class="fas fa-edit"></i> Edit
                      </button>
                      <button
                        type="button"
                        id="regenerateBtn"
                        class="btn btn-secondary"
                      >
                        <i class="fas fa-sync"></i> Regenerate
                      </button>
                    </div>
                  </div>
                  <div id="previewContent" class="preview-content"></div>
                </div>
                
                <!-- AI Output Options -->
                <div class="ai-output-options">
                  <div class="output-toggle">
                    <label class="toggle-option">
                      <input type="radio" name="urlOutputType" value="summary" checked>
                      <span class="toggle-label">
                        <i class="fas fa-sticky-note"></i> Create FlashNotes
                      </span>
                    </label>
                    <label class="toggle-option">
                      <input type="radio" name="urlOutputType" value="flashcards">
                      <span class="toggle-label">
                        <i class="fas fa-layer-group"></i> Generate Flashcards
                      </span>
                    </label>
                  </div>
                </div>

                <!-- Flashcard Options (shown when flashcards selected) -->
                <div class="generation-options" id="urlFlashcardOptions" style="display: none;">
                          <select id="urlCardType" class="select-input">
          <option value="term">Term & Definition</option>
          <option value="qa">Question & Answer</option>
          <option value="cloze">Cloze</option>
          <option value="contextual">Contextual/Scenario-based</option>
        </select>
                  <select id="urlCardCount" class="select-input">
                    <option value="5">5 cards</option>
                    <option value="10">10 cards</option>
                    <option value="15" class="premium-option">15 cards</option>
                    <option value="20" class="premium-option">20 cards</option>
                  </select>
                </div>

                <!-- FlashNotes Options (shown when summary selected) -->
                <div class="generation-options" id="urlSummaryOptions">
                  <select id="urlSummaryType" class="select-input">
                    <option value="quick">Bullet Point FlashNotes</option>
                    <option value="detailed" class="pro-option">Paragraph FlashNotes (Pro+)</option>
                    <option value="study" class="premium-option">Study Guide (Premium)</option>
                  </select>
                </div>

                <button
                  type="submit"
                  class="btn btn-primary"
                  id="generateFromUrlBtn"
                  disabled
                >
                  <i class="fas fa-magic"></i> <span id="urlGenerateButtonText">Create FlashNotes</span>
                </button>
              </div>
              <p class="url-help">
                Supports academic papers (DOI), Wikipedia articles, blog posts,
                YouTube links, and more.
                <br /><small
                  ><strong>Note:</strong> YouTube transcript extraction requires
                  manual setup. For YouTube videos, try copying the
                  auto-generated transcript (CC → More → Transcript) or upload a
                  text file instead.</small
                >
              </p>
            </form>
          </div>
        </div>

        <!-- Right Column - Flashcard Viewer -->
        <div class="grid-item">
          <div class="deck-title-container">
            <h2 id="deckTitle" class="deck-title">FlashNotes</h2>
            <button id="editDeckNameBtn" class="btn-edit-deck-name" style="display: none;" title="Edit deck name">
              <i class="fas fa-edit"></i>
            </button>
            <input type="text" id="deckNameInput" class="deck-name-input" style="display: none;" placeholder="Enter deck name" maxlength="50">
          </div>
          <div
            id="loadingIndicator"
            class="loading-overlay"
            style="display: none"
          >
            <div class="loading-content">
              <div class="spinner"></div>
              <div class="loading-message">
                <h3>Generating Flashcards</h3>
                <p class="loading-subtitle">This may take a few moments...</p>
              </div>
            </div>
          </div>
          <div id="flashcardContainer" class="flashcard-container">
            <div id="emptyState" class="empty-state">
              <div class="icon">📝</div>
              <p>Upload a file or enter text to generate flashcards</p>
              <button
                id="studyNowBtn"
                class="btn btn-primary"
                style="display: none"
              >
                <i class="fas fa-play"></i> Study Now
                <span class="due-count"></span>
              </button>
            </div>
            <div
              id="flashcardViewer"
              class="flashcard-viewer"
              style="display: none"
            >
              <div class="progress-container">
                <div class="progress-bar">
                  <div id="progressBar" class="progress"></div>
                </div>
                <div class="progress-info">
                  <span id="progressText">0/0 cards reviewed</span>
                  <div class="flashcard-actions-dropdown">
                    <button id="actionsDropdownBtn" class="btn btn-actions" title="More actions">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div id="actionsDropdownMenu" class="dropdown-menu">
                      <a href="#" id="studyNowAction" class="dropdown-item">
                        <i class="fas fa-play"></i>
                        <span>Study Now</span>
                        <small class="due-count"></small>
                      </a>
                      <a href="#" id="takeQuizAction" class="dropdown-item">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Take Quiz</span>
                      </a>
                      <a href="#" id="saveEditAction" class="dropdown-item">
                        <i class="fas fa-save"></i>
                        <span>Save and Edit</span>
                      </a>
                      <a href="#" id="exportAction" class="dropdown-item">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div id="deckTagsContainer" class="deck-tags-container" style="display: none;">
                <div id="deckTagsList" class="deck-tags-list">
                  <!-- Deck tags will be populated here -->
                </div>
              </div>
              <div id="flashcard" class="flashcard">
                <div class="flashcard-inner">
                  <div class="card-front">
                    <div id="cardFront">
                      <!-- Front content will be dynamically inserted here -->
                    </div>
                    <div class="flip-hint">
                      <i class="fas fa-hand-pointer"></i>
                      Click to flip
                    </div>
                  </div>
                  <div class="card-back">
                    <div id="cardBack">
                      <!-- Back content will be dynamically inserted here -->
                    </div>
                    <div class="flip-hint">
                      <i class="fas fa-hand-pointer"></i>
                      Click to flip back
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-controls">
                <div class="navigation-buttons">
                  <button id="prevCardBtn" class="btn btn-secondary">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <button id="shuffleBtn" class="btn btn-secondary">
                    <i class="fas fa-random"></i>
                  </button>
                  <button id="nextCardBtn" class="btn btn-secondary">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>

                <div class="performance-buttons">
                  <button class="btn btn-danger" data-performance="1" title="I completely forgot this - show again soon (Keyboard: 1)">
                    <i class="fas fa-times"></i> Again
                    <small>Forgot it</small>
                  </button>
                  <button class="btn btn-warning" data-performance="2" title="I found this difficult but remembered - show earlier (Keyboard: 2)">
                    <i class="fas fa-clock"></i> Hard
                    <small>Struggled</small>
                  </button>
                  <button class="btn btn-success" data-performance="3" title="I remembered this correctly - normal interval (Keyboard: 3)">
                    <i class="fas fa-check"></i> Good
                    <small>Remembered</small>
                  </button>
                  <button class="btn btn-primary" data-performance="4" title="This was too easy - show much later (Keyboard: 4)">
                    <i class="fas fa-star"></i> Easy
                    <small>Too easy</small>
                  </button>
                </div>
                <div class="keyboard-hints">
                  <small><i class="fas fa-keyboard"></i> Quick keys: 1-Again | 2-Hard | 3-Good | 4-Easy</small>
                </div>
              </div>
            </div>
            
            <!-- Summary Container for FlashNotes -->
            <div id="summaryContainer" class="summary-container" style="display: none;">
              <div class="summary-header">
                <h3><i class="fas fa-sticky-note"></i> FlashNotes</h3>
                <div class="summary-actions">
                  <button id="generateFlashcardsFromSummary" class="btn btn-primary btn-sm" style="display: none;">
                    <i class="fas fa-layer-group"></i> Create Flashcards
                  </button>
                  <button id="exportSummary" class="btn btn-secondary btn-sm">
                    <i class="fas fa-download"></i> Export
                  </button>
                  <button id="shareSummary" class="btn btn-secondary btn-sm">
                    <i class="fas fa-share"></i> Share
                  </button>
                </div>
              </div>
              <div id="summaryContent" class="summary-content">
                <div id="summarizeLoading" class="loading-state" style="display: none;">
                  <div class="spinner"></div>
                  <p>Generating FlashNotes...</p>
                </div>
                <div id="summaryText" class="summary-text"></div>
              </div>
              <div class="summary-stats">
                <span id="summaryWordCount">0 words</span>
                <span id="summaryReadTime">~0 min read</span>
                <span id="timeSaved">Time saved: ~0 min</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer will be loaded here -->

    <script type="module">
      import { initializeNavigation } from "./nav-template.js";
      document.addEventListener("DOMContentLoaded", initializeNavigation);
    </script>
    <script type="module" src="./spacedRepetition.js"></script>
    <script type="module" src="./deckManager.js"></script>
    <script src="./text-requirements.js"></script>
    <script type="module" src="./summarizeManager.js"></script>
    <script type="module" src="./app.js"></script>
    <script type="module">
      import { initializeFooter } from "./footer-template.js";
      document.addEventListener("DOMContentLoaded", initializeFooter);
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize dynamic elements to be hidden
        const cardTypeSelection = document.getElementById("cardTypeSelection");
        const urlPreview = document.getElementById("urlPreview");
        if (cardTypeSelection) cardTypeSelection.classList.remove("show");
        if (urlPreview) urlPreview.classList.remove("show");
        
        var tabBtns = document.querySelectorAll(".input-tabs .tab-btn");
        var tabContents = document.querySelectorAll(".input-tab-content");
        tabBtns.forEach(function (btn) {
          btn.addEventListener("click", function () {
            var tab = btn.getAttribute("data-tab");
            tabBtns.forEach(function (b) {
              b.classList.remove("active");
            });
            tabContents.forEach(function (tc) {
              tc.classList.remove("active");
            });
            btn.classList.add("active");
            var tabContent = document.getElementById(tab + "Tab");
            if (tabContent) tabContent.classList.add("active");
          });
        });



        // TTS functionality is now centralized in app.js and auto-initialized



        // Function to update Study Now action with due count
        function updateStudyNowAction() {
          const studyNowAction = document.getElementById("studyNowAction");
          const dueCountEl = studyNowAction?.querySelector(".due-count");
          
          if (!studyNowAction || !dueCountEl) return;

          if (!window.flashcards || window.flashcards.length === 0) {
            return;
          }

          // Show count for new cards
          if (window.flashcards.length > 0) {
            dueCountEl.textContent = `(${window.flashcards.length} new)`;
          }
        }

        // Listen for flashcards generated event to store flashcards globally
        document.addEventListener("flashcardsGenerated", function(event) {
          if (event.detail && event.detail.flashcards) {
            window.flashcards = event.detail.flashcards;
            console.log("Flashcards stored globally:", window.flashcards.length, "cards");
            
            // Update the Study Now action
            updateStudyNowAction();
          }
        });

        // Listen for flashcards cleared event
        document.addEventListener("flashcardsCleared", function() {
          window.flashcards = [];
          console.log("Flashcards cleared from global storage");
        });

        // Initialize Flashcard Actions Dropdown
        const actionsDropdownBtn = document.getElementById("actionsDropdownBtn");
        const actionsDropdownMenu = document.getElementById("actionsDropdownMenu");
        
        if (actionsDropdownBtn && actionsDropdownMenu) {
          // Toggle dropdown on click
          actionsDropdownBtn.addEventListener("click", function(e) {
            e.stopPropagation();
            actionsDropdownMenu.classList.toggle("show");
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", function(e) {
            if (!actionsDropdownBtn.contains(e.target) && !actionsDropdownMenu.contains(e.target)) {
              actionsDropdownMenu.classList.remove("show");
            }
          });

          // Study Now Action
          document.getElementById("studyNowAction").addEventListener("click", function(e) {
            e.preventDefault();
            actionsDropdownMenu.classList.remove("show");
            
            if (!window.flashcards || window.flashcards.length === 0) {
              alert("No flashcards available. Please generate flashcards first.");
              return;
            }

            // Call the initializeStudySession function from app.js
            if (typeof window.initializeStudySession === 'function') {
              window.initializeStudySession();
            } else {
              // Fallback: trigger the study now button click
              const studyNowBtn = document.getElementById("studyNowBtn");
              if (studyNowBtn) {
                studyNowBtn.click();
              } else {
                alert("Study functionality not available. Please try again.");
              }
            }
          });

          // Take Quiz Action
          document.getElementById("takeQuizAction").addEventListener("click", function(e) {
            e.preventDefault();
            actionsDropdownMenu.classList.remove("show");
            
            if (!window.flashcards || window.flashcards.length === 0) {
              alert("No flashcards available. Please generate flashcards first.");
              return;
            }

            // Create a quiz deck from current flashcards
            const quizDeck = {
              name: window.APP_CONFIG?.QUIZ_NAME || "Generated Flashcard Quiz",
              description: window.APP_CONFIG?.QUIZ_DESCRIPTION || "Quiz generated from your flashcards",
              cards: window.flashcards,
              id: `quiz_${Date.now()}`,
              createdAt: new Date().toISOString(),
            };

            // Store the deck in sessionStorage and redirect to quiz.html
            sessionStorage.setItem("quizDeck", JSON.stringify(quizDeck));
            window.location.href = "quiz.html";
          });

          // Save and Edit Action
          document.getElementById("saveEditAction").addEventListener("click", function(e) {
            e.preventDefault();
            actionsDropdownMenu.classList.remove("show");
            
            if (!window.flashcards || window.flashcards.length === 0) {
              alert("No flashcards available. Please generate flashcards first.");
              return;
            }

            // For now, show a placeholder - you can implement this later
            alert("Save and Edit functionality will be implemented soon!");
          });

          // Export Action
          document.getElementById("exportAction").addEventListener("click", function(e) {
            e.preventDefault();
            actionsDropdownMenu.classList.remove("show");
            
            if (!window.flashcards || window.flashcards.length === 0) {
              alert("No flashcards available. Please generate flashcards first.");
              return;
            }

            // Create a simple deck object for export
            const deckToExport = {
              name: "Generated Flashcards",
              description: "Exported flashcard deck",
              cards: window.flashcards,
              id: `export_${Date.now()}`,
              createdAt: new Date().toISOString(),
            };

            // Call export function if available
            if (typeof window.exportDeck === 'function') {
              window.exportDeck(deckToExport);
            } else {
              // Fallback: simple JSON download
              const dataStr = JSON.stringify(deckToExport, null, 2);
              const dataBlob = new Blob([dataStr], {type: 'application/json'});
              const url = URL.createObjectURL(dataBlob);
              const link = document.createElement('a');
              link.href = url;
              link.download = 'flashcards.json';
              link.click();
              URL.revokeObjectURL(url);
            }
          });
        }

        // TTS functionality is now centralized in app.js
        
        // Initialize edit deck name functionality
        setTimeout(() => {
          if (typeof window.initializeEditDeckName === 'function') {
            window.initializeEditDeckName();
          }
        }, 100);

        // Global function to update card content while preserving flip structure
        window.updateFlipCardContent = function (frontContent, backContent) {
          const cardFront = document.getElementById("cardFront");
          const cardBack = document.getElementById("cardBack");

          if (cardFront && cardBack) {
            cardFront.innerHTML = frontContent || "";
            cardBack.innerHTML = backContent || "";
          } else {
            // Structure doesn't exist, initialize it first
            window.initializeFlipCard();
            // Try again after initialization
            const newCardFront = document.getElementById("cardFront");
            const newCardBack = document.getElementById("cardBack");
            if (newCardFront && newCardBack) {
              newCardFront.innerHTML = frontContent || "";
              newCardBack.innerHTML = backContent || "";
            }
          }
          // Reset flip state and hide performance buttons
          
          // Ensure card starts in unflipped state
          const flashcard = document.getElementById("flashcard");
          if (flashcard) {
            flashcard.classList.remove("flipped");
            console.log("Card reset to unflipped state for new content");
          }
          
          // Hide performance buttons initially (they'll show after flip + delay)
          const performanceButtons = document.querySelector(".performance-buttons");
          if (performanceButtons) {
            performanceButtons.classList.remove("show");
          }
          
          // TTS is auto-initialized by app.js
        };

        // Global function to ensure flip functionality is active
        window.initializeFlipCard = function () {
          const flashcard = document.getElementById("flashcard");
          console.log("initializeFlipCard called - initial classes:", flashcard ? flashcard.className : "flashcard not found");
          if (flashcard) {
            // Ensure flashcard maintains proper height
            flashcard.style.height = "400px";
            flashcard.style.minHeight = "400px";
            flashcard.style.maxHeight = "400px";

            // Check if we need to restructure the flashcard
            const inner = flashcard.querySelector(".flashcard-inner");
            if (!inner) {
              // Save existing content
              const existingContent = flashcard.innerHTML;

              // Check if there are existing front/back divs
              const frontDiv = flashcard.querySelector(".card-front");
              const backDiv = flashcard.querySelector(".card-back");

              // Look for cardFront and cardBack content specifically
              const cardFrontEl = flashcard.querySelector("#cardFront");
              const cardBackEl = flashcard.querySelector("#cardBack");

              let frontContent = "";
              let backContent = "";

              if (cardFrontEl && cardBackEl) {
                // Extract content from existing cardFront/cardBack
                frontContent = cardFrontEl.innerHTML;
                backContent = cardBackEl.innerHTML;
              } else if (frontDiv && backDiv) {
                // Extract content from existing structure
                frontContent = frontDiv.innerHTML;
                backContent = backDiv.innerHTML;
              } else {
                // Try to extract from any existing content
                const textContent = existingContent
                  .replace(/<[^>]*>/g, "")
                  .trim();
                if (
                  textContent &&
                  textContent !== "Click here to generate flashcards"
                ) {
                  frontContent = existingContent;
                  backContent = "Generate flashcards to see the answer";
                } else {
                  frontContent = "Click here to generate flashcards";
                  backContent = "Generate flashcards to see the answer";
                }
              }

              // Recreate the flip structure with proper height enforcement
              flashcard.innerHTML = `
                <div class="flashcard-inner">
                  <div class="card-front">
                    <div id="cardFront">${frontContent}</div>
                    <div class="flip-hint">
                      <i class="fas fa-hand-pointer"></i>
                      Click to flip
                    </div>
                  </div>
                  <div class="card-back">
                    <div id="cardBack">${backContent}</div>
                    <div class="flip-hint">
                      <i class="fas fa-hand-pointer"></i>
                      Click to flip back
                    </div>
                  </div>
                </div>
              `;
            }
            // Reset flip state
            flashcard.classList.remove("flipped");
            console.log("initializeFlipCard - classes after reset:", flashcard.className);
          }
        };

        // Monitor for changes to flashcard content
        const flashcardContainer = document.getElementById("flashcard");
        if (flashcardContainer) {
          const observer = new MutationObserver(function (mutations) {
            let shouldReinitialize = false;
            let heightChanged = false;

            mutations.forEach(function (mutation) {
              if (
                mutation.type === "childList" &&
                mutation.target.id === "flashcard"
              ) {
                // Check if the flip structure was removed
                const inner =
                  flashcardContainer.querySelector(".flashcard-inner");
                if (!inner) {
                  shouldReinitialize = true;
                }
              }

              // Check for height/style changes
              if (
                mutation.type === "attributes" &&
                (mutation.attributeName === "style" ||
                  mutation.attributeName === "class")
              ) {
                const currentHeight = flashcardContainer.style.height;
                if (currentHeight && currentHeight !== "400px") {
                  heightChanged = true;
                }
              }
            });

            if (shouldReinitialize) {
              // Flashcard structure was replaced, restore flip functionality
              setTimeout(function () {
                window.initializeFlipCard();
              }, 50);
            } else if (heightChanged) {
              // Just fix the height without full reinitialization
              flashcardContainer.style.height = "400px";
              flashcardContainer.style.minHeight = "400px";
              flashcardContainer.style.maxHeight = "400px";
            }
          });

          observer.observe(flashcardContainer, {
            childList: true,
            attributes: true,
            attributeFilter: ["style", "class"],
            subtree: false, // Only watch direct children of flashcard
          });
        }

        // Track when flipped class gets added unexpectedly
        function setupFlipClassWatcher() {
          const flashcard = document.getElementById("flashcard");
          if (flashcard) {
            const observer = new MutationObserver(function(mutations) {
              mutations.forEach(function(mutation) {
                if (mutation.type === "attributes" && mutation.attributeName === "class") {
                  if (flashcard.classList.contains("flipped")) {
                    console.log("🚨 FLIPPED CLASS ADDED by something else! Stack trace:");
                    console.trace();
                    console.log("Current classes:", flashcard.className);
                  }
                }
              });
            });
            
            observer.observe(flashcard, {
              attributes: true,
              attributeFilter: ["class"]
            });
          }
        }
        
        // Initialize flip card structure on page load
        setTimeout(function () {
          window.initializeFlipCard();
          
          // Extra safety: ensure card starts unflipped
          const flashcard = document.getElementById("flashcard");
          if (flashcard) {
            flashcard.classList.remove("flipped");
            console.log("Page load safety reset - final classes:", flashcard.className);
          }
          
          // Setup watcher
          setupFlipClassWatcher();
        }, 500);
      });
    </script>
    
    <script>
      // FlashNotes and Output Type Management
      document.addEventListener("DOMContentLoaded", function() {
        initializeSummarizeFeature();
        initializeAllOutputToggles();
        initializeSummaryActions();
      });

      function initializeSummarizeFeature() {
        const outputRadios = document.querySelectorAll('input[name="outputType"]');
        const flashcardOptions = document.getElementById('flashcardOptions');
        const summaryOptions = document.getElementById('summaryOptions');
        const generateButtonText = document.getElementById('generateButtonText');
        const textForm = document.getElementById('textForm');

        // Handle output type changes
        outputRadios.forEach(radio => {
          radio.addEventListener('change', (e) => {
            const selectedType = e.target.value;
            updateUIForOutputType(selectedType);
          });
        });

        // Handle form submission
        textForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const selectedType = document.querySelector('input[name="outputType"]:checked').value;
          const textContent = document.getElementById('textInput').value.trim();
          
          if (textContent.length < 100) {
            showNotification('Please enter at least 100 characters for better results.', 'warning');
            return;
          }

          await handleContentGeneration(selectedType, textContent);
        });

        // Initialize summary action buttons
        initializeSummaryActions();
      }

      function updateUIForOutputType(type) {
        const flashcardOptions = document.getElementById('flashcardOptions');
        const summaryOptions = document.getElementById('summaryOptions');
        const generateButtonText = document.getElementById('generateButtonText');

        switch(type) {
          case 'flashcards':
            flashcardOptions.style.display = 'flex';
            summaryOptions.style.display = 'none';
            generateButtonText.textContent = 'Generate Flashcards';
            break;
          case 'summary':
            flashcardOptions.style.display = 'none';
            summaryOptions.style.display = 'flex';
            generateButtonText.textContent = 'Generate FlashNotes';
            break;
        }
      }

      // Initialize output toggles for all tabs
      function initializeAllOutputToggles() {
        // Upload tab toggles
        const uploadRadios = document.querySelectorAll('input[name="uploadOutputType"]');
        uploadRadios.forEach(radio => {
          radio.addEventListener('change', (e) => {
            updateUploadUIForOutputType(e.target.value);
          });
        });

        // URL tab toggles  
        const urlRadios = document.querySelectorAll('input[name="urlOutputType"]');
        urlRadios.forEach(radio => {
          radio.addEventListener('change', (e) => {
            updateUrlUIForOutputType(e.target.value);
          });
        });
      }

      function updateUploadUIForOutputType(type) {
        const flashcardOptions = document.getElementById('uploadFlashcardOptions');
        const summaryOptions = document.getElementById('uploadSummaryOptions');
        const generateButtonText = document.getElementById('uploadGenerateButtonText');

        switch(type) {
          case 'flashcards':
            flashcardOptions.style.display = 'flex';
            summaryOptions.style.display = 'none';
            generateButtonText.textContent = 'Generate Flashcards';
            break;
          case 'summary':
            flashcardOptions.style.display = 'none';
            summaryOptions.style.display = 'flex';
            generateButtonText.textContent = 'Generate FlashNotes';
            break;
        }
      }

      function updateUrlUIForOutputType(type) {
        const flashcardOptions = document.getElementById('urlFlashcardOptions');
        const summaryOptions = document.getElementById('urlSummaryOptions');
        const generateButtonText = document.getElementById('urlGenerateButtonText');

        switch(type) {
          case 'flashcards':
            flashcardOptions.style.display = 'flex';
            summaryOptions.style.display = 'none';
            generateButtonText.textContent = 'Generate Flashcards';
            break;
          case 'summary':
            flashcardOptions.style.display = 'none';
            summaryOptions.style.display = 'flex';
            generateButtonText.textContent = 'Generate FlashNotes';
            break;
        }
      }

      async function handleContentGeneration(type, content) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const flashcardContainer = document.getElementById('flashcardContainer');
        const summaryContainer = document.getElementById('summaryContainer');

        try {
          // Update loading message based on content type
          if (type === 'summary') {
            window.updateLoadingMessage('Generating FlashNotes');
          } else if (type === 'flashcards') {
            window.updateLoadingMessage('Generating Flashcards');
          }
          
          loadingIndicator.style.display = 'flex';

          if (type === 'summary') {
            await generateSummary(content);
            summaryContainer.style.display = 'block';
          }

          if (type === 'flashcards') {
            // Use existing flashcard generation logic
            await window.processText(content);
          }

        } catch (error) {
          console.error('Error generating content:', error);
          showNotification('Failed to generate content. Please try again.', 'error');
        } finally {
          loadingIndicator.style.display = 'none';
        }
      }

      async function generateSummary(content) {
        const summaryType = document.getElementById('summaryType')?.value || 'detailed';
        const summaryTextElement = document.getElementById('summaryText');
        const summaryWordCount = document.getElementById('summaryWordCount');
        const summaryReadTime = document.getElementById('summaryReadTime');
        const timeSaved = document.getElementById('timeSaved');
        const generateFlashcardsBtn = document.getElementById('generateFlashcardsFromSummary');

        if (!window.summarizeManager) {
          showNotification('Summarize feature not available. Please refresh the page.', 'error');
          return;
        }

        try {
          const summary = await window.summarizeManager.generateSummary(content, {
            type: summaryType,
            includeKeyPoints: true
          });

          if (summary) {
            // Display the summary
            summaryTextElement.innerHTML = formatSummary(summary, summaryType);
            
            // Update stats
            const wordCount = summary.split(' ').length;
            const readTime = Math.ceil(wordCount / 200); // Average reading speed
            const originalWords = content.split(' ').length;
            const originalReadTime = Math.ceil(originalWords / 200);
            const savedTime = Math.max(0, originalReadTime - readTime);

            summaryWordCount.textContent = `${wordCount} words`;
            summaryReadTime.textContent = `~${readTime} min read`;
            timeSaved.textContent = `Time saved: ~${savedTime} min`;

            // Show create flashcards button for summary
            generateFlashcardsBtn.style.display = 'inline-block';
            generateFlashcardsBtn.onclick = () => generateFlashcardsFromSummary(summary);

            showNotification('Summary generated successfully!', 'success');
          }
        } catch (error) {
          console.error('Error generating summary:', error);
          showNotification('Failed to generate summary. Please try again.', 'error');
        }
      }

      function formatSummary(summary, type) {
        switch(type) {
          case 'bullet':
            // Convert to bullet points if not already formatted
            if (!summary.includes('•') && !summary.includes('-')) {
              const sentences = summary.split('. ');
              return '<ul>' + sentences.map(s => `<li>${s.trim()}</li>`).join('') + '</ul>';
            }
            return summary.replace(/•/g, '<li>').replace(/- /g, '<li>');
          case 'study':
            // Highlight important terms
            return summary.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          default:
            return summary;
        }
      }

      async function generateFlashcardsFromSummary(summary) {
        try {
          showNotification('Generating flashcards from summary...', 'info');
          await window.processText(summary);
          showNotification('Flashcards generated from summary!', 'success');
        } catch (error) {
          console.error('Error generating flashcards from summary:', error);
          showNotification('Failed to generate flashcards from summary.', 'error');
        }
      }

      function initializeSummaryActions() {
        // Export summary
        const exportBtn = document.getElementById('exportSummary');
        if (exportBtn) {
          exportBtn.addEventListener('click', async () => {
            const summaryText = document.getElementById('summaryText').textContent;
            if (summaryText && window.summarizeManager) {
              // Use the tier-restricted export method
              await window.summarizeManager.exportFlashNotes(summaryText, 'flashnotes.txt');
            } else if (summaryText) {
              // Fallback for when summarizeManager is not available
              exportSummaryAsText(summaryText);
            }
          });
        }

        // Share summary
        const shareBtn = document.getElementById('shareSummary');
        if (shareBtn) {
          shareBtn.addEventListener('click', () => {
            const summaryText = document.getElementById('summaryText').textContent;
            if (summaryText && navigator.share) {
              navigator.share({
                title: 'AI Generated Summary',
                text: summaryText
              });
            } else {
              // Fallback: copy to clipboard
              navigator.clipboard.writeText(summaryText).then(() => {
                showNotification('Summary copied to clipboard!', 'success');
              });
            }
          });
        }
      }

      function exportSummaryAsText(summary) {
        const blob = new Blob([summary], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'summary.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification('Summary exported!', 'success');
      }

      function showNotification(message, type = 'info') {
        // Use existing notification system from app.js
        if (window.showSuccessMessage && type === 'success') {
          window.showSuccessMessage(message);
        } else if (window.showErrorMessage && type === 'error') {
          window.showErrorMessage(message);
        } else {
          // Create a simple notification for other types
          console.log(`${type.toUpperCase()}: ${message}`);
          createSimpleNotification(message, type);
        }
      }

      function createSimpleNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 4px;
          color: white;
          font-weight: 500;
          z-index: 10000;
          max-width: 300px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        `;
        
        // Set background color based on type
        switch(type) {
          case 'success':
            notification.style.backgroundColor = '#28a745';
            break;
          case 'error':
            notification.style.backgroundColor = '#dc3545';
            break;
          case 'info':
          default:
            notification.style.backgroundColor = '#17a2b8';
        }
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }
    </script>
  </body>
</html>
