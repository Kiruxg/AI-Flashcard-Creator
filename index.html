<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="Note2Flash_logo.ico" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="theme-color" content="#2a7f62" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="format-detection" content="telephone=no" />
    <meta
      http-equiv="Cross-Origin-Opener-Policy"
      content="same-origin-allow-popups"
    />
    <title>Note2Flash - AI-Powered Flashcard Generator</title>
    <link rel="icon" type="image/png" href="Note2Flash_logo.png" />
    <link rel="stylesheet" href="styles.css" />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Other Dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- PDF.js -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"
      defer
    ></script>
    <script>
      // Initialize PDF.js worker
      window.addEventListener("load", function () {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      });
    </script>
    <!-- mammoth.js for DOCX processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- File type detection -->
    <script src="https://cdn.jsdelivr.net/npm/file-type@18.7.1/browser.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="./supabase-config.js"></script>
    <script type="module" src="./config.js"></script>
    <script type="module" src="./spacedRepetition.js"></script>
    <script type="module" src="./deckManager.js"></script>
    <script type="module" src="./app.js"></script>
    
    <style>
      /* Flip Card Styles */
      .flashcard {
        perspective: 1000px !important;
        cursor: pointer !important;
        height: 400px !important;
        min-height: 400px !important;
        max-height: 400px !important;
        width: 100% !important;
        margin-bottom: 20px !important;
        position: relative !important;
        overflow: visible !important;
        display: block !important;
      }

      .flashcard-inner {
        position: relative !important;
        width: 100% !important;
        height: 100% !important;
        text-align: center !important;
        transition: transform 0.8s !important;
        transform-style: preserve-3d !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        min-height: 400px !important;
        max-height: 400px !important;
        display: block !important;
      }

      .flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg);
      }

      .card-front,
      .card-back {
        position: absolute !important;
        width: 100% !important;
        height: 100% !important;
        backface-visibility: hidden !important;
        border-radius: 12px !important;
        padding: 30px !important;
        box-sizing: border-box !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        text-align: center !important;
        overflow: hidden !important;
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
        min-height: 400px !important;
        max-height: 400px !important;
      }

      .card-front {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid #dee2e6;
        font-size: 1.3rem;
        line-height: 1.6;
        color: #343a40;
      }

      .card-back {
        background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
        border: 2px solid #28a745;
        transform: rotateY(180deg);
        font-size: 1.2rem;
        line-height: 1.6;
        color: #155724;
      }

      .card-front strong,
      .card-back strong {
        color: #2a7f62;
        display: block;
        margin-bottom: 15px;
        font-size: 1.1em;
      }

      .flip-hint {
        position: absolute;
        bottom: 15px;
        right: 20px;
        font-size: 0.9rem;
        color: #6c757d;
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0.7;
        transition: opacity 0.3s;
      }

      .flashcard:hover .flip-hint {
        opacity: 1;
      }

      /* Ensure flashcard container takes full space */
      .flashcard-container {
        width: 100% !important;
        height: auto !important;
        min-height: 450px !important;
        padding: 20px !important;
      }

      .flashcard-viewer {
        width: 100% !important;
        height: auto !important;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .flashcard {
          height: 350px !important;
          min-height: 350px !important;
          max-height: 350px !important;
        }

        .flashcard-inner {
          min-height: 350px !important;
          max-height: 350px !important;
        }

        .card-front,
        .card-back {
          font-size: 1.1rem !important;
          padding: 20px !important;
          min-height: 350px !important;
          max-height: 350px !important;
        }

        .flip-hint {
          font-size: 0.8rem !important;
          bottom: 12px !important;
          right: 15px !important;
        }

        .flashcard-container {
          min-height: 400px !important;
          padding: 15px !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation will be loaded here -->
    <div id="nav-placeholder"></div>

    <!-- Password Reset Modal -->
    <div id="resetPasswordModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Reset Password</h2>
        <form id="resetPasswordForm" class="auth-form">
          <div class="form-group">
            <input
              type="email"
              id="resetEmail"
              placeholder="Enter your email"
              required
              autocomplete="email"
            />
          </div>
          <button type="submit" class="btn btn-primary">Send Reset Link</button>
        </form>
      </div>
    </div>

    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-content">
        <h1>Transform Your Notes into Smart Flashcards</h1>
        <p class="hero-subtitle">
          Drop in your PDFs, paste YouTube links, upload lecture notes, or snap photos‚Äîour AI creates perfect flashcards from any source in seconds.
        </p>
        <div class="hero-cta">
          <a href="create-deck.html" class="btn btn-primary btn-large"
            >Create Free Flashcards</a
          >
          <a href="#how-it-works" class="btn btn-secondary btn-large"
            >See How It Works</a
          >
        </div>
      </div>
    </section>

    <!-- Features Section -->
    <section class="features" id="how-it-works">
      <div class="features-sticky-container">
        <h2>Why Choose Note2Flash?</h2>
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon">
              <i class="fas fa-magic"></i>
            </div>
            <h3>AI-Powered Learning</h3>
            <p>
              Tired of staring at walls of text? Our AI instantly transforms boring lecture notes into engaging flashcards that actually stick in your brain.
            </p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <h3>Lightning Fast</h3>
            <p>
              Create decks in seconds, not hours. Save time and focus on
              learning.
            </p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">
              <i class="fas fa-brain"></i>
            </div>
            <h3>Smart Learning</h3>
            <p>Adaptive spaced repetition helps you learn more effectively.</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">
              <i class="fas fa-share-alt"></i>
            </div>
            <h3>Share & Collaborate</h3>
            <p>
              Share decks with classmates or discover community-created content.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- How It Works Section -->
    <section class="how-it-works">
      <h2>How to Never Forget What You Study Again</h2>
      <div class="steps">
        <div class="step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h3>Drop Your Material</h3>
            <p>
              Upload lecture notes, textbooks, PDFs, or paste any text. Works
              with photos of handwritten notes too.
            </p>
          </div>
        </div>
        <div class="step">
          <div class="step-number">2</div>
          <div class="step-content">
            <h3>AI Works Its Magic</h3>
            <p>
              Advanced AI extracts key concepts, creates meaningful questions,
              and formats perfect study cards automatically.
            </p>
          </div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h3>Fine-Tune Your Deck</h3>
            <p>
              Review, edit, and personalize cards. Add images, adjust
              difficulty, or reorganize to match your learning style.
            </p>
          </div>
        </div>
        <div class="step">
          <div class="step-number">4</div>
          <div class="step-content">
            <h3>Study Smarter, Not Harder</h3>
            <p>
              Our intelligent spaced repetition adapts to your progress,
              ensuring you remember what matters most.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section" id="create-cards">
      <div class="cta-content">
        <h2>Ready to Transform Your Learning?</h2>
        <p>
          Join thousands of students and professionals who are learning smarter
          with Note2Flash.
        </p>
        <div class="cta-buttons">
          <a href="create-deck.html" class="btn btn-primary btn-large"
            >Start Creating Free</a
          >
          <a href="pricing.html" class="btn btn-secondary btn-large"
            >Learn More</a
          >
        </div>
      </div>
    </section>

    <div class="container">
      <!-- Quota Tracker for Free Users -->
      <div
        id="quotaTracker"
        class="quota-tracker"
        style="display: none; margin-bottom: 1rem"
      >
        <span id="flashcardQuotaText"></span>
        <span id="occlusionQuotaText" style="margin-left: 1.5rem"></span>
        <button
          id="upgradeBtn"
          class="btn btn-sm btn-primary"
          style="margin-left: 2rem"
        >
          Upgrade for more
        </button>
      </div>

      <div class="grid-container">
        <!-- Left Column - Input Section -->
        <div class="grid-item">
          <h2>Create Flashcards</h2>
          <div class="input-tabs">
            <button class="tab-btn active" data-tab="text">Text Input</button>
            <button class="tab-btn" data-tab="content">Content Upload</button>
            <button class="tab-btn" data-tab="url">Web Content</button>
          </div>

          <!-- Text Input Tab -->
          <div class="input-tab-content active" id="textTab">
            <form id="textForm" class="text-input-container">
              <textarea
                id="textInput"
                class="text-area-input"
                placeholder="Enter or paste your text here... 
Examples:
- Class notes
- Important concepts
- Step-by-step procedures
- Technical specifications"
                rows="10"
              ></textarea>

              <div class="generation-options">
                      <select id="textCardType" class="select-input">
        <option value="term">Term & Definition</option>
        <option value="qa">Question & Answer</option>
        <option value="cloze">Cloze</option>
        <option value="contextual">Contextual/Scenario-based</option>
      </select>
                <select id="textCardCount" class="select-input">
                  <option value="5">5 cards</option>
                  <option value="10">10 cards</option>
                  <option value="15" class="premium-option">15 cards</option>
                  <option value="20" class="premium-option">20 cards</option>
                </select>
              </div>

              <button
                type="submit"
                class="btn btn-primary"
                id="generateFromTextBtn"
              >
                <i class="fas fa-magic"></i> Generate Flashcards
              </button>
            </form>
          </div>

          <!-- Content Upload Tab -->
          <div class="input-tab-content" id="contentTab">
            <div class="dropzone" id="dropzone">
              <i class="fas fa-cloud-upload-alt upload-icon"></i>
              <p>Drag & drop files here or click to upload</p>
              <p class="file-types">
                Supported files: PDF, DOCX, TXT, JPG, PNG
              </p>
              <input
                type="file"
                id="fileInput"
                accept=".pdf,.docx,.txt,.jpg,.jpeg,.png"
                style="display: none"
              />
            </div>

            <!-- Card Type Selection -->
            <div id="cardTypeSelection">
                      <select id="uploadCardType" class="select-input">
          <option value="term" selected>Term & Definition</option>
          <option value="qa">Question & Answer</option>
          <option value="cloze">Cloze</option>
          <option value="contextual">Contextual/Scenario-based</option>
          <option value="image-occlusion" class="premium-option">Image Occlusion (Premium)</option>
        </select>
              <select id="uploadCardCount" class="select-input">
                <option value="5">5 cards</option>
                <option value="10">10 cards</option>
                <option value="15">15 cards (Premium)</option>
                <option value="20">20 cards (Premium)</option>
              </select>
              <button id="generateCardsBtn" class="btn btn-primary">
                Generate Cards
              </button>
            </div>
          </div>

          <!-- Web Content Tab -->
          <div class="input-tab-content" id="urlTab">
            <form id="urlForm">
              <div class="url-input-container">
                <div class="url-input-wrapper">
                  <input
                    type="url"
                    id="urlInput"
                    placeholder="https://example.com/article or 10.1234/example.doi"
                    class="url-input"
                  />
                </div>
                <div id="urlPreview" class="url-preview">
                  <div class="preview-header">
                    <h3 id="previewTitle">Content Preview</h3>
                    <div class="preview-actions">
                      <button
                        type="button"
                        id="editContentBtn"
                        class="btn btn-secondary"
                      >
                        <i class="fas fa-edit"></i> Edit
                      </button>
                      <button
                        type="button"
                        id="regenerateBtn"
                        class="btn btn-secondary"
                      >
                        <i class="fas fa-sync"></i> Regenerate
                      </button>
                    </div>
                  </div>
                  <div id="previewContent" class="preview-content"></div>
                </div>
                <div class="generation-options">
                          <select id="urlCardType" class="select-input">
          <option value="term">Term & Definition</option>
          <option value="qa">Question & Answer</option>
          <option value="cloze">Cloze</option>
          <option value="contextual">Contextual/Scenario-based</option>
        </select>
                  <select id="urlCardCount" class="select-input">
                    <option value="5">5 cards</option>
                    <option value="10">10 cards</option>
                    <option value="15" class="premium-option">15 cards</option>
                    <option value="20" class="premium-option">20 cards</option>
                  </select>
                </div>
                <button
                  type="submit"
                  class="btn btn-primary"
                  id="generateFromUrlBtn"
                  disabled
                >
                  <i class="fas fa-magic"></i> Generate Flashcards
                </button>
              </div>
              <p class="url-help">
                Supports academic papers (DOI), Wikipedia articles, blog posts,
                YouTube links, and more.
                <br /><small
                  ><strong>Note:</strong> YouTube transcript extraction requires
                  manual setup. For YouTube videos, try copying the
                  auto-generated transcript (CC ‚Üí More ‚Üí Transcript) or upload a
                  text file instead.</small
                >
              </p>
            </form>
          </div>
        </div>

        <!-- Right Column - Flashcard Viewer -->
        <div class="grid-item">
          <div class="deck-title-container">
            <h2 id="deckTitle" class="deck-title">Flashcard Viewer</h2>
            <button id="editDeckNameBtn" class="btn-edit-deck-name" style="display: none;" title="Edit deck name">
              <i class="fas fa-edit"></i>
            </button>
          </div>
          <input type="text" id="deckNameInput" class="deck-name-input" style="display: none;" placeholder="Enter deck name" maxlength="50">
          <div
            id="loadingIndicator"
            class="loading-overlay"
            style="display: none"
          >
            <div class="loading-content">
              <div class="spinner"></div>
              <div class="loading-message">
                <h3>Generating Flashcards</h3>
                <p class="loading-subtitle">This may take a few moments...</p>
              </div>
            </div>
          </div>
          <div id="flashcardContainer" class="flashcard-container">
            <div id="emptyState" class="empty-state">
              <div class="icon">üìù</div>
              <p>Upload a file or enter text to generate flashcards</p>
              <button
                id="studyNowBtn"
                class="btn btn-primary"
                style="display: none"
              >
                <i class="fas fa-play"></i> Study Now
                <span class="due-count"></span>
              </button>
            </div>
            <div
              id="flashcardViewer"
              class="flashcard-viewer"
              style="display: none"
            >
              <div class="progress-container">
                <div class="progress-bar">
                  <div id="progressBar" class="progress"></div>
                </div>
                <span id="progressText">0/0 cards reviewed</span>
              </div>
              <div id="flashcard" class="flashcard">
                <div class="flashcard-inner">
                  <div class="card-front">
                    <div id="cardFront">
                      <!-- Front content will be dynamically inserted here -->
                    </div>
                    <div class="flip-hint">
                      <i class="fas fa-hand-pointer"></i>
                      Click to flip
                    </div>
                  </div>
                  <div class="card-back">
                    <div id="cardBack">
                      <!-- Back content will be dynamically inserted here -->
                    </div>
                    <div class="flip-hint">
                      <i class="fas fa-hand-pointer"></i>
                      Click to flip back
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-controls">
                <div class="navigation-buttons">
                  <button id="prevCardBtn" class="btn btn-secondary">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <button id="shuffleBtn" class="btn btn-secondary">
                    <i class="fas fa-random"></i>
                  </button>
                  <button id="nextCardBtn" class="btn btn-secondary">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
                <div class="performance-buttons">
                  <button class="btn btn-danger" data-performance="1">
                    <i class="fas fa-tools"></i> Need Practice
                  </button>
                  <button class="btn btn-success" data-performance="5">
                    <i class="fas fa-check-circle"></i> Confident
                  </button>
                </div>

                <!-- Quiz Button - redirects to centralized quiz -->
                <div class="quiz-actions">
                  <button id="takeQuizBtn" class="btn btn-primary">
                    <i class="fas fa-graduation-cap"></i> Take Quiz
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Premium Modal -->
    <div id="premiumModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Upgrade to Premium</h2>

        <!-- Free Tier Features -->
        <div class="tier-features free">
          <h3>Free Tier</h3>
          <ul>
            <li>‚úì 20 flashcards per month</li>
            <li>‚úì 3 saved decks</li>
            <li>‚úì Basic card types</li>
            <li>‚úì 1 export per month</li>
          </ul>
        </div>

        <!-- Premium Features -->
        <div class="premium-features">
          <h3>Premium Features</h3>
          <ul>
            <li>‚ú® Unlimited flashcard generation</li>
            <li>üíæ Save unlimited decks</li>
            <li>üì± Access on all devices</li>
            <li>üéØ All card types</li>
            <li>üìä Detailed study statistics</li>
            <li>üë• Priority support</li>
          </ul>
        </div>

        <!-- Pricing Options -->
        <div class="pricing-options">
          <div class="pricing-card">
            <h3>Free</h3>
            <p class="price">$0/month</p>
            <ul class="features">
              <li>‚úì 3 AI deck generations/month</li>
              <li>‚úì Max 10 cards per deck</li>
              <li>‚úì 2 total saved decks</li>
              <li>‚úì Basic card types</li>
              <li>‚úì File uploads & web content</li>
            </ul>
            <button
              class="btn btn-secondary"
              onclick="window.location.href='create-deck.html'"
            >
              Get Started Free
            </button>
          </div>

          <div class="pricing-card">
            <h3>Basic</h3>
            <p class="price">$7.99/month</p>
            <ul class="features">
              <li>‚úì 25 AI deck generations/month</li>
              <li>‚úì Up to 25 cards per deck</li>
              <li>‚úì Up to 25 saved decks</li>
              <li>‚úì All card types (including Image Occlusion)</li>
              <li>‚úì Explainer Assistant (20 credits/month)</li>
            </ul>
            <button
              class="btn btn-secondary"
              id="basicHomepageBtn"
            >
              Start with Basic
            </button>
          </div>

          <div class="pricing-card featured">
            <div class="best-value">üöÄ Power User Choice</div>
            <h3>Premium</h3>
            <p class="price">$14.99/month</p>
            <p class="save">Perfect for serious students</p>
            <ul class="features">
              <li>‚úì 100 AI deck generations/month</li>
              <li>‚úì Up to 100 cards per deck</li>
              <li>‚úì Up to 100 saved decks</li>
              <li>‚úì All card types & advanced features</li>
              <li>‚úì Explainer Assistant (100 credits/month)</li>
            </ul>
            <button
              class="btn btn-primary"
              id="premiumHomepageBtn"
            >
              Get Premium
            </button>
          </div>
        </div>

        <!-- Current Subscription Status -->
        <div
          class="subscription-status"
          id="subscriptionStatus"
          style="display: none"
        >
          <h3>Current Subscription</h3>
          <p id="currentPlan"></p>
          <p id="nextBillingDate"></p>
          <button class="btn btn-secondary" id="cancelSubBtn">
            Cancel Subscription
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="./config.js"></script>
    <script type="module" src="./spacedRepetition.js"></script>
    <script type="module" src="./deckManager.js"></script>
    <script type="module" src="./app.js"></script>
    <script type="module">
      import { initializeNavigation } from "./nav-template.js";
      // Initialize navigation as soon as the DOM is ready
      document.addEventListener("DOMContentLoaded", initializeNavigation);
    </script>

    <script type="module">
      import { initializeFooter } from "./footer-template.js";
      // Initialize footer
      document.addEventListener("DOMContentLoaded", initializeFooter);
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize dynamic elements to be hidden
        const cardTypeSelection = document.getElementById("cardTypeSelection");
        const urlPreview = document.getElementById("urlPreview");
        if (cardTypeSelection) cardTypeSelection.classList.remove("show");
        if (urlPreview) urlPreview.classList.remove("show");
        
        var tabBtns = document.querySelectorAll(".input-tabs .tab-btn");
        var tabContents = document.querySelectorAll(".input-tab-content");
        tabBtns.forEach(function (btn) {
          btn.addEventListener("click", function () {
            var tab = btn.getAttribute("data-tab");
            tabBtns.forEach(function (b) {
              b.classList.remove("active");
            });
            tabContents.forEach(function (tc) {
              tc.classList.remove("active");
            });
            btn.classList.add("active");
            var tabContent = document.getElementById(tab + "Tab");
            if (tabContent) tabContent.classList.add("active");
          });
        });

        // Flashcard flip functionality - only listen to specific content areas
        document.addEventListener("click", function (e) {
          // Only proceed if NOT clicking on any interactive elements first
          const isInteractiveElement =
            e.target.closest(".card-controls") ||
            e.target.closest("button") ||
            e.target.closest(".btn") ||
            e.target.closest("input") ||
            e.target.closest("select") ||
            e.target.closest(".navigation-buttons") ||
            e.target.closest(".performance-buttons") ||
            e.target.closest(".quiz-actions");

          if (isInteractiveElement) {
            return; // Don't flip if clicking interactive elements
          }

          // Check if clicking within the flashcard content area
          const flashcard = e.target.closest(".flashcard");
          const isClickingCardContent =
            e.target.closest("#cardFront") ||
            e.target.closest("#cardBack") ||
            e.target.closest(".card-front") ||
            e.target.closest(".card-back") ||
            e.target.closest(".flip-hint");

          if (flashcard && isClickingCardContent) {
            console.log("Flipping card!");
            flashcard.classList.toggle("flipped");
          }
        });

        // Function to reset card flip state
        function resetCardFlip() {
          const flashcard = document.getElementById("flashcard");
          if (flashcard) {
            flashcard.classList.remove("flipped");
          }
        }

        // Function to initialize TTS buttons (if any)
        function initializeTTSButtons() {
          // Add TTS functionality if needed
        }

        // Add event listener for Take Quiz button
        const takeQuizBtn = document.getElementById("takeQuizBtn");
        if (takeQuizBtn) {
          takeQuizBtn.addEventListener("click", function() {
            // Check if we have flashcards available
            if (!window.flashcards || window.flashcards.length === 0) {
              alert("No flashcards available. Please generate flashcards first.");
              return;
            }

            // Create a quiz deck from current flashcards
            const quizDeck = {
              name: "Generated Flashcard Quiz",
              description: "Quiz generated from your flashcards",
              cards: window.flashcards,
              id: `quiz_${Date.now()}`,
              createdAt: new Date().toISOString(),
            };

            // Store the deck in sessionStorage and redirect to quiz.html
            sessionStorage.setItem("quizDeck", JSON.stringify(quizDeck));
            window.location.href = "quiz.html";
          });
        }

        // Make functions available globally for other scripts
        window.resetCardFlip = resetCardFlip;
        window.initializeTTSButtons = initializeTTSButtons;
        
        // Initialize edit deck name functionality
        setTimeout(() => {
          if (typeof window.initializeEditDeckName === 'function') {
            window.initializeEditDeckName();
          }
        }, 100);

        // Global function to update card content while preserving flip structure
        window.updateFlipCardContent = function (frontContent, backContent) {
          const cardFront = document.getElementById("cardFront");
          const cardBack = document.getElementById("cardBack");

          if (cardFront && cardBack) {
            cardFront.innerHTML = frontContent || "";
            cardBack.innerHTML = backContent || "";
          } else {
            // Structure doesn't exist, initialize it first
            window.initializeFlipCard();
            // Try again after initialization
            const newCardFront = document.getElementById("cardFront");
            const newCardBack = document.getElementById("cardBack");
            if (newCardFront && newCardBack) {
              newCardFront.innerHTML = frontContent || "";
              newCardBack.innerHTML = backContent || "";
            }
          }
          // Reset flip state and reinitialize TTS
          window.resetCardFlip();
          setTimeout(window.initializeTTSButtons, 50);
        };

        // Global function to ensure flip functionality is active
        window.initializeFlipCard = function () {
          const flashcard = document.getElementById("flashcard");
          if (flashcard) {
            // Ensure flashcard maintains proper height
            flashcard.style.height = "400px";
            flashcard.style.minHeight = "400px";
            flashcard.style.maxHeight = "400px";

            // Check if we need to restructure the flashcard
            const inner = flashcard.querySelector(".flashcard-inner");
            if (!inner) {
              // Save existing content
              const existingContent = flashcard.innerHTML;

              // Check if there are existing front/back divs
              const frontDiv = flashcard.querySelector(".card-front");
              const backDiv = flashcard.querySelector(".card-back");

              // Look for cardFront and cardBack content specifically
              const cardFrontEl = flashcard.querySelector("#cardFront");
              const cardBackEl = flashcard.querySelector("#cardBack");

              let frontContent = "";
              let backContent = "";

              if (cardFrontEl && cardBackEl) {
                // Extract content from existing cardFront/cardBack
                frontContent = cardFrontEl.innerHTML;
                backContent = cardBackEl.innerHTML;
              } else if (frontDiv && backDiv) {
                // Extract content from existing structure
                frontContent = frontDiv.innerHTML;
                backContent = backDiv.innerHTML;
              } else {
                // Try to extract from any existing content
                const textContent = existingContent
                  .replace(/<[^>]*>/g, "")
                  .trim();
                if (
                  textContent &&
                  textContent !== "Click here to generate flashcards"
                ) {
                  frontContent = existingContent;
                  backContent = "Generate flashcards to see the answer";
                } else {
                  frontContent = "Click here to generate flashcards";
                  backContent = "Generate flashcards to see the answer";
                }
              }

              // Recreate the flip structure with proper height enforcement
              flashcard.innerHTML = `
                <div class="flashcard-inner">
                  <div class="card-front">
                    <div id="cardFront">${frontContent}</div>
                    <div class="flip-hint">
                      <i class="fas fa-hand-pointer"></i>
                      Click to flip
                    </div>
                  </div>
                  <div class="card-back">
                    <div id="cardBack">${backContent}</div>
                    <div class="flip-hint">
                      <i class="fas fa-hand-pointer"></i>
                      Click to flip back
                    </div>
                  </div>
                </div>
              `;
            }
            // Reset flip state
            flashcard.classList.remove("flipped");
          }
        };

        // Monitor for changes to flashcard content
        const flashcardContainer = document.getElementById("flashcard");
        if (flashcardContainer) {
          const observer = new MutationObserver(function (mutations) {
            let shouldReinitialize = false;
            let heightChanged = false;

            mutations.forEach(function (mutation) {
              if (
                mutation.type === "childList" &&
                mutation.target.id === "flashcard"
              ) {
                // Check if the flip structure was removed
                const inner =
                  flashcardContainer.querySelector(".flashcard-inner");
                if (!inner) {
                  shouldReinitialize = true;
                }
              }

              // Check for height/style changes
              if (
                mutation.type === "attributes" &&
                (mutation.attributeName === "style" ||
                  mutation.attributeName === "class")
              ) {
                const currentHeight = flashcardContainer.style.height;
                if (currentHeight && currentHeight !== "400px") {
                  heightChanged = true;
                }
              }
            });

            if (shouldReinitialize) {
              // Flashcard structure was replaced, restore flip functionality
              setTimeout(function () {
                window.initializeFlipCard();
              }, 50);
            } else if (heightChanged) {
              // Just fix the height without full reinitialization
              flashcardContainer.style.height = "400px";
              flashcardContainer.style.minHeight = "400px";
              flashcardContainer.style.maxHeight = "400px";
            }
          });

          observer.observe(flashcardContainer, {
            childList: true,
            attributes: true,
            attributeFilter: ["style", "class"],
            subtree: false, // Only watch direct children of flashcard
          });
        }

        // Initialize flip card structure on page load
        setTimeout(function () {
          window.initializeFlipCard();
        }, 500);

        // Homepage pricing button event listeners
        const basicHomepageBtn = document.getElementById("basicHomepageBtn");
        const premiumHomepageBtn = document.getElementById("premiumHomepageBtn");

        if (basicHomepageBtn) {
          basicHomepageBtn.addEventListener("click", () => {
            window.location.href = "pricing.html";
          });
        }

        if (premiumHomepageBtn) {
          premiumHomepageBtn.addEventListener("click", () => {
            window.location.href = "pricing.html";
          });
        }
      });
    </script>

    <!-- Horizontal Scroll on Vertical Scroll Script - REMOVED -->
    <!-- <script>
      // Horizontal scrolling functionality has been disabled
    </script> -->

    <!-- Add card type specific UI elements -->
    <div id="cardTypeOptions" class="card-type-options" style="display: none">
      <!-- Term & Definition options -->
      <div class="card-type-option" data-type="term">
        <div class="option-group">
          <label>
            <input
              type="checkbox"
              name="termOptions"
              value="includePronunciation"
            />
            Include pronunciation guides
          </label>
          <label>
            <input type="checkbox" name="termOptions" value="includeExamples" />
            Include usage examples
          </label>
        </div>
      </div>

      <!-- Question & Answer options -->
      <div class="card-type-option" data-type="qa">
        <div class="option-group">
          <label>
            <input
              type="checkbox"
              name="qaOptions"
              value="includeExplanation"
            />
            Include detailed explanations
          </label>
          <label>
            <input type="checkbox" name="qaOptions" value="includeExamples" />
            Include examples
          </label>
        </div>
      </div>

      <!-- Cloze options -->
      <div class="card-type-option" data-type="cloze">
        <div class="option-group">
          <label>
            <input type="checkbox" name="clozeOptions" value="includeHints" />
            Include hints
          </label>
          <label>
            <input type="checkbox" name="clozeOptions" value="multipleBlanks" />
            Allow multiple blanks
          </label>
        </div>
      </div>

      <!-- Image Occlusion options -->
      <div class="card-type-option" data-type="image-occlusion">
        <div class="option-group">
          <label>
            <input type="file" name="occlusionImage" accept="image/*" />
            üì∏ Upload image for occlusion
          </label>
          <div class="occlusion-editor" style="display: none">
            <canvas id="occlusionCanvas"></canvas>
            <div class="occlusion-controls">
              <button type="button" id="addOcclusion">
                <i class="fas fa-plus"></i> Draw Occlusion
              </button>
              <button type="button" id="removeOcclusion">
                <i class="fas fa-trash"></i> Remove Selected
              </button>
              <button type="button" id="clearOcclusions">
                <i class="fas fa-eraser"></i> Clear All
              </button>
              <button type="button" id="autoOcclusion">
                <i class="fas fa-magic"></i> AI Auto-Occlusion
              </button>
            </div>
            <div class="occlusion-info">
              <i class="fas fa-info-circle"></i>
              Click and drag to create occlusion areas. Each area will become a separate flashcard.
            </div>
            <div class="occlusion-list" id="occlusionList"></div>
          </div>
        </div>
      </div>

      <!-- Contextual options -->
      <div class="card-type-option" data-type="contextual">
        <div class="option-group">
          <label>
            <input
              type="checkbox"
              name="contextOptions"
              value="includeRealWorld"
            />
            Include real-world scenarios
          </label>
          <label>
            <input
              type="checkbox"
              name="contextOptions"
              value="includeExamples"
            />
            Include examples
          </label>
        </div>
      </div>
    </div>

    <!-- Update the card preview section -->
    <div id="cardPreview" class="card-preview" style="display: none">
      <div class="preview-controls">
        <button type="button" id="prevCard">Previous</button>
        <span id="cardCounter">Card 1 of 1</span>
        <button type="button" id="nextCard">Next</button>
      </div>
      <div id="previewContainer" class="preview-container">
        <!-- Cards will be rendered here -->
      </div>
    </div>

    <!-- Add necessary scripts -->
    <script type="module">
      import { CardTypeManager } from "./cardTypeManager_new.js";

      // Initialize card type manager
      const cardTypeManager = new CardTypeManager();

      // Card type selection handler
      const cardType = document.getElementById("cardType");
      if (cardType) {
        cardType.addEventListener("change", (e) => {
          const selectedType = e.target.value;
          const optionsContainer = document.getElementById("cardTypeOptions");
          const typeOptions =
            optionsContainer.querySelectorAll(".card-type-option");

          // Hide all options first
          typeOptions.forEach((opt) => (opt.style.display = "none"));
          optionsContainer.style.display = "none";

          // Show relevant options
          const selectedOption = optionsContainer.querySelector(
            `[data-type="${selectedType}"]`
          );
          if (selectedOption) {
            selectedOption.style.display = "block";
            optionsContainer.style.display = "block";
          }

          // Special handling for image occlusion
          if (selectedType === "image-occlusion") {
            initializeImageOcclusionEditor();
          }
        });
      }

      // Image occlusion editor initialization
      function initializeImageOcclusionEditor() {
        const canvas = document.getElementById("occlusionCanvas");
        const ctx = canvas.getContext("2d");
        const occlusionList = document.getElementById("occlusionList");
        
        let currentImage = null;
        let occlusions = [];
        let isDrawing = false;
        let startX, startY;
        let selectedOcclusion = null;

        // Set up canvas with proper scaling
        function setupCanvas(image) {
          const maxWidth = 800;
          const maxHeight = 600;
          
          let { width, height } = image;
          
          // Scale down if too large
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width *= ratio;
            height *= ratio;
          }
          
          canvas.width = width;
          canvas.height = height;
          canvas.style.width = width + 'px';
          canvas.style.height = height + 'px';
          
          ctx.drawImage(image, 0, 0, width, height);
          currentImage = image;
          drawOcclusions();
        }

        // Draw all occlusions on canvas
        function drawOcclusions() {
          if (!currentImage) return;
          
          // Clear and redraw image
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
          
          // Draw occlusions
          occlusions.forEach((occ, index) => {
            ctx.fillStyle = selectedOcclusion === index ? 
              "rgba(0, 123, 255, 0.7)" : "rgba(0, 0, 0, 0.6)";
            ctx.fillRect(occ.x, occ.y, occ.width, occ.height);
            
            // Draw border
            ctx.strokeStyle = selectedOcclusion === index ? 
              "#007bff" : "#fff";
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(occ.x, occ.y, occ.width, occ.height);
            ctx.setLineDash([]);
            
            // Draw label
            if (occ.label) {
              ctx.fillStyle = "#fff";
              ctx.font = "14px Arial, sans-serif";
              ctx.fillText(occ.label, occ.x + 5, occ.y + 20);
            }
          });
        }

        // Update occlusion list display
        function updateOcclusionList() {
          occlusionList.innerHTML = occlusions.map((occ, index) => `
            <div class="occlusion-item ${selectedOcclusion === index ? 'selected' : ''}" data-index="${index}">
              <div>
                <span class="occlusion-item-label">${occ.label || `Occlusion ${index + 1}`}</span>
                <span class="occlusion-item-coords">(${Math.round(occ.x)}, ${Math.round(occ.y)}, ${Math.round(occ.width)}√ó${Math.round(occ.height)})</span>
              </div>
              <div class="occlusion-item-actions">
                <button class="edit-occlusion" onclick="editOcclusion(${index})">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="delete-occlusion" onclick="deleteOcclusion(${index})">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `).join('');
        }

        // Handle image upload
        document.querySelector('input[name="occlusionImage"]').addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) {
            if (!file.type.startsWith('image/')) {
              alert('Please upload a valid image file.');
              return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
              const img = new Image();
              img.onload = () => {
                setupCanvas(img);
                document.querySelector(".occlusion-editor").style.display = "block";
                occlusions = []; // Reset occlusions for new image
                updateOcclusionList();
              };
              img.src = event.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

        // Canvas drawing events
        canvas.addEventListener("mousedown", (e) => {
          const rect = canvas.getBoundingClientRect();
          startX = e.clientX - rect.left;
          startY = e.clientY - rect.top;
          
          // Check if clicking on existing occlusion
          const clickedOcclusion = occlusions.findIndex(occ => 
            startX >= occ.x && startX <= occ.x + occ.width &&
            startY >= occ.y && startY <= occ.y + occ.height
          );
          
          if (clickedOcclusion !== -1) {
            selectedOcclusion = clickedOcclusion;
            drawOcclusions();
            updateOcclusionList();
          } else {
            selectedOcclusion = null;
            isDrawing = true;
            updateOcclusionList();
          }
        });

        canvas.addEventListener("mousemove", (e) => {
          if (!isDrawing) return;
          
          const rect = canvas.getBoundingClientRect();
          const currentX = e.clientX - rect.left;
          const currentY = e.clientY - rect.top;
          
          // Redraw image and existing occlusions
          drawOcclusions();
          
          // Draw current selection rectangle
          const width = currentX - startX;
          const height = currentY - startY;
          
          ctx.strokeStyle = "#007bff";
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.strokeRect(startX, startY, width, height);
          ctx.setLineDash([]);
          
          ctx.fillStyle = "rgba(0, 123, 255, 0.3)";
          ctx.fillRect(startX, startY, width, height);
        });

        canvas.addEventListener("mouseup", (e) => {
          if (!isDrawing) return;
          isDrawing = false;
          
          const rect = canvas.getBoundingClientRect();
          const endX = e.clientX - rect.left;
          const endY = e.clientY - rect.top;
          
          const width = endX - startX;
          const height = endY - startY;
          
          // Only create occlusion if it's large enough
          if (Math.abs(width) > 20 && Math.abs(height) > 20) {
            const label = prompt("Enter label for this occlusion area:", `Area ${occlusions.length + 1}`);
            if (label !== null) {
              occlusions.push({
                x: Math.min(startX, endX),
                y: Math.min(startY, endY),
                width: Math.abs(width),
                height: Math.abs(height),
                label: label.trim() || `Area ${occlusions.length + 1}`
              });
              drawOcclusions();
              updateOcclusionList();
            }
          } else {
            drawOcclusions(); // Redraw to remove the selection rectangle
          }
        });

        // Control button handlers
        document.getElementById("removeOcclusion").addEventListener("click", () => {
          if (selectedOcclusion !== null) {
            occlusions.splice(selectedOcclusion, 1);
            selectedOcclusion = null;
            drawOcclusions();
            updateOcclusionList();
          } else {
            alert("Please select an occlusion area to remove.");
          }
        });

        document.getElementById("clearOcclusions").addEventListener("click", () => {
          if (occlusions.length > 0 && confirm("Are you sure you want to clear all occlusions?")) {
            occlusions = [];
            selectedOcclusion = null;
            drawOcclusions();
            updateOcclusionList();
          }
        });

        document.getElementById("autoOcclusion").addEventListener("click", async () => {
          if (!currentImage) {
            alert("Please upload an image first.");
            return;
          }
          
          try {
            // Convert canvas to blob
            canvas.toBlob(async (blob) => {
              const formData = new FormData();
              formData.append('image', blob, 'image.png');
              
              const response = await fetch('/api/auto-occlusion', {
                method: 'POST',
                body: formData
              });
              
              if (response.ok) {
                const result = await response.json();
                if (result.occlusions && result.occlusions.length > 0) {
                  occlusions = [...occlusions, ...result.occlusions];
                  drawOcclusions();
                  updateOcclusionList();
                  alert(`Added ${result.occlusions.length} auto-detected occlusion areas.`);
                } else {
                  alert("No suitable occlusion areas were detected automatically.");
                }
              } else {
                throw new Error('Auto-occlusion failed');
              }
            }, 'image/png');
          } catch (error) {
            console.error('Auto-occlusion error:', error);
            alert("Auto-occlusion is currently unavailable. Please create occlusions manually.");
          }
        });

        // Global functions for occlusion management
        window.editOcclusion = (index) => {
          const occ = occlusions[index];
          const newLabel = prompt("Edit occlusion label:", occ.label);
          if (newLabel !== null) {
            occ.label = newLabel.trim() || `Area ${index + 1}`;
            drawOcclusions();
            updateOcclusionList();
          }
        };

        window.deleteOcclusion = (index) => {
          if (confirm("Are you sure you want to delete this occlusion?")) {
            occlusions.splice(index, 1);
            if (selectedOcclusion === index) selectedOcclusion = null;
            else if (selectedOcclusion > index) selectedOcclusion--;
            drawOcclusions();
            updateOcclusionList();
          }
        };

        // Store occlusions data for form submission
        window.getOcclusionData = () => ({
          image: currentImage ? canvas.toDataURL() : null,
          occlusions: occlusions,
          imageWidth: canvas.width,
          imageHeight: canvas.height
        });
      }
    </script>
  </body>
</html>
